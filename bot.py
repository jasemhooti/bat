import os
import logging
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    MessageHandler,
    filters
)
from dotenv import load_dotenv
from database import Database
from utils.db_setup import setup_database
from utils.logger import setup_logger

# ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯Ø±
logger = setup_logger()

# Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
load_dotenv()

# Ø¯Ø±ÛŒØ§ÙØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
BOT_TOKEN = os.getenv('BOT_TOKEN')
ADMIN_ID = int(os.getenv('ADMIN_ID', 0))
WEBHOOK_URL = os.getenv('WEBHOOK_URL', '')
WEBHOOK_PORT = int(os.getenv('WEBHOOK_PORT', 8443))

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ¨â€ŒÙ‡ÙˆÚ©
WEBHOOK_MODE = os.getenv('WEBHOOK_MODE', 'polling').lower() == 'webhook'

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ø¯Ø³ØªÙˆØ± /start"""
    user = update.effective_user
    logger.info(f"Ú©Ø§Ø±Ø¨Ø± {user.id} ({user.username}) Ø¯Ø³ØªÙˆØ± /start Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ø±Ø¯")
    
    keyboard = [
        [
            InlineKeyboardButton("ğŸ“Š Ø¢Ù…Ø§Ø±", callback_data='stats'),
            InlineKeyboardButton("âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª", callback_data='settings')
        ],
        [
            InlineKeyboardButton("ğŸ“ Ø±Ø§Ù‡Ù†Ù…Ø§", callback_data='help'),
            InlineKeyboardButton("â“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ", callback_data='support')
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        f"Ø³Ù„Ø§Ù… {user.first_name}! Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.\n"
        "Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=reply_markup
    )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ†Ù„Ø§ÛŒÙ†"""
    query = update.callback_query
    await query.answer()
    
    if query.data == 'stats':
        await show_stats(query, context)
    elif query.data == 'settings':
        await show_settings(query, context)
    elif query.data == 'help':
        await show_help(query, context)
    elif query.data == 'support':
        await show_support(query, context)

async def show_stats(query, context):
    """Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±"""
    db = Database()
    stats = await db.get_stats()
    
    await query.edit_message_text(
        f"ğŸ“Š Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª:\n\n"
        f"ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {stats['total_users']}\n"
        f"âœ… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: {stats['active_users']}\n"
        f"ğŸ“ ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: {stats['total_messages']}\n"
        f"ğŸ”„ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {stats['last_update']}"
    )

async def show_settings(query, context):
    """Ù†Ù…Ø§ÛŒØ´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª"""
    keyboard = [
        [InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data='back')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª:\n\n"
        "Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.",
        reply_markup=reply_markup
    )

async def show_help(query, context):
    """Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§"""
    keyboard = [
        [InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data='back')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "ğŸ“ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª:\n\n"
        "1. Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ø² Ø¯Ø³ØªÙˆØ± /start Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n"
        "2. Ø§Ø² Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ú¯Ø²ÛŒÙ†Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯\n"
        "3. Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯",
        reply_markup=reply_markup
    )

async def show_support(query, context):
    """Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"""
    keyboard = [
        [InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data='back')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "â“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:\n\n"
        "Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:\n"
        "ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„: support@example.com\n"
        "ğŸ’¬ ØªÙ„Ú¯Ø±Ø§Ù…: @support",
        reply_markup=reply_markup
    )

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§"""
    logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: {context.error}")
    if update and update.effective_message:
        await update.effective_message.reply_text(
            "Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."
        )

async def notify_admin(message: str) -> None:
    """Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†"""
    if ADMIN_ID:
        try:
            application = Application.builder().token(BOT_TOKEN).build()
            await application.bot.send_message(chat_id=ADMIN_ID, text=message)
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†: {e}")

def main() -> None:
    """ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ"""
    try:
        # ØªÙ†Ø¸ÛŒÙ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        setup_database()
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
        application = Application.builder().token(BOT_TOKEN).build()
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
        application.add_handler(CommandHandler("start", start))
        application.add_handler(CallbackQueryHandler(button_handler))
        application.add_error_handler(error_handler)
        
        # ØªÙ†Ø¸ÛŒÙ… ÙˆØ¨â€ŒÙ‡ÙˆÚ© ÛŒØ§ Ù¾ÙˆÙ„ÛŒÙ†Ú¯
        if WEBHOOK_MODE:
            application.run_webhook(
                listen='0.0.0.0',
                port=WEBHOOK_PORT,
                url_path=BOT_TOKEN,
                webhook_url=WEBHOOK_URL
            )
        else:
            application.run_polling(allowed_updates=Update.ALL_TYPES)
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª: {e}")
        raise

if __name__ == '__main__':
    main() 